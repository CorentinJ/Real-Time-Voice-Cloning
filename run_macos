#!/bin/bash
# Helper script for running Real-Time Voice Cloning on macOS
# This script sets up the required environment variables and runs the toolbox

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if we're on macOS
if [[ "$OSTYPE" != "darwin"* ]]; then
    echo -e "${RED}Error: This script is for macOS only.${NC}"
    exit 1
fi

# Check if Homebrew is installed
if ! command -v brew &> /dev/null; then
    echo -e "${RED}Error: Homebrew is not installed. Please install it from https://brew.sh${NC}"
    exit 1
fi

# Check if required system dependencies are installed
echo -e "${YELLOW}Checking system dependencies...${NC}"
MISSING_DEPS=()

if ! brew list ffmpeg &> /dev/null; then
    MISSING_DEPS+=("ffmpeg")
fi

if ! brew list libsndfile &> /dev/null; then
    MISSING_DEPS+=("libsndfile")
fi

if ! brew list qt@5 &> /dev/null; then
    MISSING_DEPS+=("qt@5")
fi

if [ ${#MISSING_DEPS[@]} -ne 0 ]; then
    echo -e "${YELLOW}Missing dependencies: ${MISSING_DEPS[*]}${NC}"
    echo -e "${YELLOW}Installing missing dependencies...${NC}"
    brew install "${MISSING_DEPS[@]}"
fi

# Set up environment variables
export PATH="/opt/homebrew/opt/qt@5/bin:$PATH"
export CMAKE_PREFIX_PATH="/opt/homebrew/opt/qt@5"
export DYLD_LIBRARY_PATH="/opt/homebrew/lib:$DYLD_LIBRARY_PATH"

# Check if virtual environment exists
if [ ! -d ".venv" ]; then
    echo -e "${YELLOW}Virtual environment not found. Setting up...${NC}"
    
    # Check if Python 3.10 is installed
    if ! uv python list | grep -q "3.10"; then
        echo -e "${YELLOW}Installing Python 3.10...${NC}"
        uv python install 3.10
    fi
    
    uv python pin 3.10
    uv venv
    
    echo -e "${YELLOW}Installing dependencies...${NC}"
    uv pip install inflect==5.3.0 librosa==0.9.2 matplotlib==3.5.1 "numpy>=1.26,<2" Pillow==8.4.0 scikit-learn==1.0.2 "scipy>=1.7" "setuptools<=80.8.0" sounddevice==0.4.3 soundfile==0.10.3.post1 tqdm==4.62.3 umap-learn==0.5.2 Unidecode==1.3.2 urllib3==1.26.7 visdom==0.1.8.9 webrtcvad==2.0.10
    uv pip install --only-binary :all: "PyQt5>=5.15.6,<5.16"
    uv pip install --index-url https://download.pytorch.org/whl/cpu "torch>=1.13,<1.14"
fi

# Determine which script to run
SCRIPT="demo_toolbox.py"
if [ "$1" == "cli" ]; then
    SCRIPT="demo_cli.py"
fi

# Run the script
echo -e "${GREEN}Starting Real-Time Voice Cloning...${NC}"
.venv/bin/python "$SCRIPT" --cpu "${@:2}"

